###############################################################################
# ğŸ“¦ PACKAGE: fish_tank_sensors.yaml
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Template sensors that derive useful states from raw hardware readings.
# Provides health scores, status labels, maintenance countdown timers,
# and per-parameter status sensors for use in the dashboard and automations.
#
# INSTALL:
#   Drop in:  config/packages/fish_tank_sensors.yaml
#   Restart Home Assistant after adding.
#
# REQUIRES:  fish_tank_helpers.yaml (for threshold input_numbers)
# HARDWARE:  Your physical sensors should already expose entities named:
#              sensor.fish_tank_temperature
#              sensor.fish_tank_ph
#              sensor.fish_tank_ammonia
#              sensor.fish_tank_nitrite
#              sensor.fish_tank_nitrate
#              sensor.fish_tank_dissolved_o2
#              sensor.fish_tank_gh
#              sensor.fish_tank_kh
#              sensor.fish_tank_tds
#              sensor.fish_tank_co2
#              sensor.fish_tank_turbidity
#              sensor.fish_tank_water_level
###############################################################################

template:

  # â”€â”€ PARAMETER STATUS SENSORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Each returns: "optimal" | "warning" | "critical" | "unknown"
  # Used by automations and dashboard chips.

  - sensor:

      - name: fish_tank_temperature_status
        unique_id: fish_tank_temperature_status
        icon: mdi:thermometer-water
        state: >
          {% set v = states('sensor.fish_tank_temperature') | float(-1) %}
          {% set lo = states('input_number.fish_tank_temp_min') | float(72) %}
          {% set hi = states('input_number.fish_tank_temp_max') | float(80) %}
          {% if v == -1 %}unknown
          {% elif v < lo - 3 or v > hi + 3 %}critical
          {% elif v < lo or v > hi %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_ph_status
        unique_id: fish_tank_ph_status
        icon: mdi:ph
        state: >
          {% set v  = states('sensor.fish_tank_ph') | float(-1) %}
          {% set lo = states('input_number.fish_tank_ph_min') | float(6.5) %}
          {% set hi = states('input_number.fish_tank_ph_max') | float(7.5) %}
          {% if v == -1 %}unknown
          {% elif v < lo - 0.5 or v > hi + 0.5 %}critical
          {% elif v < lo or v > hi %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_ammonia_status
        unique_id: fish_tank_ammonia_status
        icon: mdi:flask-remove-outline
        state: >
          {% set v   = states('sensor.fish_tank_ammonia') | float(-1) %}
          {% set max = states('input_number.fish_tank_ammonia_max') | float(0.25) %}
          {% if v == -1 %}unknown
          {% elif v > max %}critical
          {% elif v > 0.0 %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_nitrite_status
        unique_id: fish_tank_nitrite_status
        icon: mdi:test-tube-off
        state: >
          {% set v   = states('sensor.fish_tank_nitrite') | float(-1) %}
          {% set max = states('input_number.fish_tank_nitrite_max') | float(0.25) %}
          {% if v == -1 %}unknown
          {% elif v > max %}critical
          {% elif v > 0.0 %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_nitrate_status
        unique_id: fish_tank_nitrate_status
        icon: mdi:water-percent
        state: >
          {% set v    = states('sensor.fish_tank_nitrate') | float(-1) %}
          {% set warn = states('input_number.fish_tank_nitrate_warn') | float(20) %}
          {% set max  = states('input_number.fish_tank_nitrate_max') | float(40) %}
          {% if v == -1 %}unknown
          {% elif v > max %}critical
          {% elif v > warn %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_oxygen_status
        unique_id: fish_tank_oxygen_status
        icon: mdi:air-filter
        state: >
          {% set v  = states('sensor.fish_tank_dissolved_o2') | float(-1) %}
          {% set lo = states('input_number.fish_tank_o2_min') | float(6) %}
          {% if v == -1 %}unknown
          {% elif v < lo - 1 %}critical
          {% elif v < lo %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_gh_status
        unique_id: fish_tank_gh_status
        icon: mdi:water-opacity
        state: >
          {% set v  = states('sensor.fish_tank_gh') | float(-1) %}
          {% set lo = states('input_number.fish_tank_gh_min') | float(4) %}
          {% set hi = states('input_number.fish_tank_gh_max') | float(12) %}
          {% if v == -1 %}unknown
          {% elif v < lo or v > hi %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_kh_status
        unique_id: fish_tank_kh_status
        icon: mdi:shield-water
        state: >
          {% set v  = states('sensor.fish_tank_kh') | float(-1) %}
          {% set lo = states('input_number.fish_tank_kh_min') | float(4) %}
          {% set hi = states('input_number.fish_tank_kh_max') | float(8) %}
          {% if v == -1 %}unknown
          {% elif v < lo or v > hi %}warning
          {% else %}optimal{% endif %}

      - name: fish_tank_co2_status
        unique_id: fish_tank_co2_status
        icon: mdi:molecule-co2
        state: >
          {% if is_state('input_boolean.fish_tank_planted_tank', 'off') %}
            not_applicable
          {% else %}
            {% set v  = states('sensor.fish_tank_co2') | float(-1) %}
            {% set lo = states('input_number.fish_tank_co2_min') | float(15) %}
            {% set hi = states('input_number.fish_tank_co2_max') | float(30) %}
            {% if v == -1 %}unknown
            {% elif v > hi + 10 %}critical
            {% elif v < lo or v > hi %}warning
            {% else %}optimal{% endif %}
          {% endif %}

      # â”€â”€ OVERALL TANK HEALTH SCORE (0â€“100) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Weighted: nitrogen params count most, then temp/pH, then hardness
      - name: fish_tank_health_score
        unique_id: fish_tank_health_score
        unit_of_measurement: "%"
        icon: mdi:heart-pulse
        state: >
          {% set statuses = [
            states('sensor.fish_tank_temperature_status'),
            states('sensor.fish_tank_ph_status'),
            states('sensor.fish_tank_ammonia_status'),
            states('sensor.fish_tank_nitrite_status'),
            states('sensor.fish_tank_nitrate_status'),
            states('sensor.fish_tank_oxygen_status')
          ] %}
          {% set score = namespace(val=100) %}
          {% for s in statuses %}
            {% if s == 'critical' %}{% set score.val = score.val - 20 %}
            {% elif s == 'warning' %}{% set score.val = score.val - 8 %}
            {% endif %}
          {% endfor %}
          {{ [score.val, 0] | max }}
        attributes:
          status_breakdown: >
            Temp: {{ states('sensor.fish_tank_temperature_status') }},
            pH: {{ states('sensor.fish_tank_ph_status') }},
            NHâ‚ƒ: {{ states('sensor.fish_tank_ammonia_status') }},
            NOâ‚‚: {{ states('sensor.fish_tank_nitrite_status') }},
            NOâ‚ƒ: {{ states('sensor.fish_tank_nitrate_status') }},
            Oâ‚‚: {{ states('sensor.fish_tank_oxygen_status') }}

      # â”€â”€ OVERALL TANK STATUS (for header banner) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: fish_tank_overall_status
        unique_id: fish_tank_overall_status
        icon: mdi:fishbowl
        state: >
          {% set amm_s = states('sensor.fish_tank_ammonia_status') %}
          {% set no2_s = states('sensor.fish_tank_nitrite_status') %}
          {% set tmp_s = states('sensor.fish_tank_temperature_status') %}
          {% set ph_s  = states('sensor.fish_tank_ph_status') %}
          {% set no3_s = states('sensor.fish_tank_nitrate_status') %}
          {% set o2_s  = states('sensor.fish_tank_oxygen_status') %}
          {% if amm_s == 'critical' or no2_s == 'critical' %}critical
          {% elif tmp_s == 'critical' or ph_s == 'critical' %}critical
          {% elif 'warning' in [amm_s, no2_s, tmp_s, ph_s, no3_s, o2_s] %}warning
          {% else %}healthy{% endif %}
        attributes:
          message: >
            {% set amm = states('sensor.fish_tank_ammonia') | float(0) %}
            {% set no2 = states('sensor.fish_tank_nitrite') | float(0) %}
            {% set tmp = states('sensor.fish_tank_temperature') | float(0) %}
            {% set ph  = states('sensor.fish_tank_ph') | float(0) %}
            {% set no3 = states('sensor.fish_tank_nitrate') | float(0) %}
            {% set o2  = states('sensor.fish_tank_dissolved_o2') | float(0) %}
            {% set lo_t = states('input_number.fish_tank_temp_min') | float(72) %}
            {% set hi_t = states('input_number.fish_tank_temp_max') | float(80) %}
            {% if amm > 0.25 %}
              ğŸš¨ CRITICAL: Ammonia at {{ amm }} ppm â€” immediate 25% water change needed!
            {% elif no2 > 0.25 %}
              ğŸš¨ CRITICAL: Nitrite at {{ no2 }} ppm â€” check your cycle, water change now!
            {% elif tmp < lo_t or tmp > hi_t %}
              âš ï¸ Temperature {{ tmp }}Â°F out of range ({{ lo_t }}â€“{{ hi_t }}Â°F)
            {% elif ph < 6.5 or ph > 7.5 %}
              âš ï¸ pH {{ ph }} out of safe range (6.5â€“7.5)
            {% elif no3 > 40 %}
              âš ï¸ Nitrate high at {{ no3 }} ppm â€” schedule water change soon
            {% elif o2 < 6 %}
              âš ï¸ Low dissolved oxygen ({{ o2 }} mg/L) â€” check air pump
            {% else %}
              âœ… All parameters within safe range â€” tank is healthy!
            {% endif %}

  # â”€â”€ MAINTENANCE COUNTDOWN SENSORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - sensor:

      - name: fish_tank_days_since_water_change
        unique_id: fish_tank_days_since_water_change
        unit_of_measurement: days
        icon: mdi:water-sync
        state: >
          {% set ts = as_timestamp(states('input_datetime.fish_tank_last_water_change'), 0) %}
          {% if ts < 86400 %}
            0
          {% else %}
            {{ ((now().timestamp() - ts) / 86400) | round(1) }}
          {% endif %}
        attributes:
          logged: >
            {{ as_timestamp(states('input_datetime.fish_tank_last_water_change'), 0) > 86400 }}
          last_date: >
            {% set ts = as_timestamp(states('input_datetime.fish_tank_last_water_change'), 0) %}
            {{ as_local(as_datetime(ts)).strftime('%d %b %Y %H:%M') if ts > 86400 else 'Not logged yet' }}

      - name: fish_tank_days_since_filter_clean
        unique_id: fish_tank_days_since_filter_clean
        unit_of_measurement: days
        icon: mdi:air-filter
        state: >
          {% set ts = as_timestamp(states('input_datetime.fish_tank_last_filter_clean'), 0) %}
          {% if ts < 86400 %}
            0
          {% else %}
            {{ ((now().timestamp() - ts) / 86400) | round(1) }}
          {% endif %}
        attributes:
          logged: >
            {{ as_timestamp(states('input_datetime.fish_tank_last_filter_clean'), 0) > 86400 }}
          last_date: >
            {% set ts = as_timestamp(states('input_datetime.fish_tank_last_filter_clean'), 0) %}
            {{ as_local(as_datetime(ts)).strftime('%d %b %Y %H:%M') if ts > 86400 else 'Not logged yet' }}

      - name: fish_tank_days_since_fert_dose
        unique_id: fish_tank_days_since_fert_dose
        unit_of_measurement: days
        icon: mdi:leaf
        state: >
          {% set ts = as_timestamp(states('input_datetime.fish_tank_last_fert_dose'), 0) %}
          {% if ts < 86400 %}
            0
          {% else %}
            {{ ((now().timestamp() - ts) / 86400) | round(1) }}
          {% endif %}
        attributes:
          logged: >
            {{ as_timestamp(states('input_datetime.fish_tank_last_fert_dose'), 0) > 86400 }}
          last_date: >
            {% set ts = as_timestamp(states('input_datetime.fish_tank_last_fert_dose'), 0) %}
            {{ as_local(as_datetime(ts)).strftime('%d %b %Y %H:%M') if ts > 86400 else 'Not logged yet' }}

      - name: fish_tank_water_change_due_in
        unique_id: fish_tank_water_change_due_in
        unit_of_measurement: days
        icon: mdi:calendar-clock
        state: >
          {% set days_since = states('sensor.fish_tank_days_since_water_change') | float(0) %}
          {% set interval = states('input_number.fish_tank_water_change_interval') | float(7) %}
          {% set logged = state_attr('sensor.fish_tank_days_since_water_change', 'logged') %}
          {% if not logged %}
            {{ interval | round(1) }}
          {% else %}
            {{ (interval - days_since) | round(1) }}
          {% endif %}
        attributes:
          overdue: >
            {{ states('sensor.fish_tank_water_change_due_in') | float(0) < 0 }}

      - name: fish_tank_filter_clean_due_in
        unique_id: fish_tank_filter_clean_due_in
        unit_of_measurement: days
        icon: mdi:calendar-clock
        state: >
          {% set days_since = states('sensor.fish_tank_days_since_filter_clean') | float(0) %}
          {% set interval = states('input_number.fish_tank_filter_clean_interval') | float(14) %}
          {% set logged = state_attr('sensor.fish_tank_days_since_filter_clean', 'logged') %}
          {% if not logged %}
            {{ interval | round(1) }}
          {% else %}
            {{ (interval - days_since) | round(1) }}
          {% endif %}

      - name: fish_tank_tank_age_days
        unique_id: fish_tank_tank_age_days
        unit_of_measurement: days
        icon: mdi:calendar-range
        state: >
          {% set ts = as_timestamp(states('input_datetime.fish_tank_setup_date'), none) %}
          {% if ts is none %}
            0
          {% else %}
            {{ ((now().timestamp() - ts) / 86400) | int }}
          {% endif %}
        availability: >
          {{ states('input_datetime.fish_tank_setup_date') not in ['unknown', 'unavailable', ''] }}
        attributes:
          setup_date: >
            {% set last = states('input_datetime.fish_tank_setup_date') %}
            {{ last if as_timestamp(last, none) is not none else 'Not set' }}
