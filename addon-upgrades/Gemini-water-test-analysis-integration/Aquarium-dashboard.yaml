###############################################################
# AQUARIUM WATER TEST â€” DASHBOARD TAB
# Add as a new View in your existing dashboard
#
# REQUIREMENTS (install via HACS):
#   - Browser Mod (thomasloven/hass-browser_mod)
#   - card-mod (thomasloven/lovelace-card-mod)     [for coloured borders]
#   - mini-graph-card (kalkih/lovelace-mini-graph-card) [for history graphs]
#
# HOW TO ADD THIS TAB:
#   1. Open your dashboard â†’ Edit â†’ Add View
#   2. Switch to YAML editor
#   3. Paste the contents below
###############################################################

title: ğŸŸ Aquarium
path: aquarium
icon: mdi:fish
badges:
  # â”€â”€ SEACHEM AMMONIA BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Reflects the physical Seachem Ammonia Alert card colour
  - type: entity
    entity: sensor.aquarium_seachem_badge
    name: "Seachem"
    color: >
      {% set s = states('sensor.aquarium_seachem_badge') | lower %}
      {% if s == 'safe' %}green
      {% elif s == 'alert' %}yellow
      {% elif s == 'alarm' %}orange
      {% elif s == 'toxic' %}red
      {% else %}grey{% endif %}

  # â”€â”€ AMMONIA ALERT BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Floats above the dashboard. Red/amber/green based on ammonia.
  - type: entity
    entity: sensor.aquarium_ammonia_alert
    name: "NH3"
    color: >
      {% set s = states('sensor.aquarium_ammonia_alert') %}
      {% if s == 'DANGER' %}red
      {% elif s == 'WARNING' %}orange
      {% elif s == 'Safe' %}green
      {% else %}grey{% endif %}

  # â”€â”€ WATER STATUS BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - type: entity
    entity: sensor.aquarium_water_status
    name: "Water"
    color: >
      {% set s = states('sensor.aquarium_water_status') | lower %}
      {% if s == 'good' %}green
      {% elif s == 'warning' %}orange
      {% elif s == 'danger' %}red
      {% else %}grey{% endif %}

cards:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 1 â€” STATUS OVERVIEW
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: horizontal-stack
    cards:
      - type: entity
        entity: sensor.aquarium_water_status
        name: "Water Status"
        card_mod:
          style: |
            ha-card {
              border-left: 6px solid
                {% if states('sensor.aquarium_water_status') == 'Good' %}#4caf50
                {% elif states('sensor.aquarium_water_status') == 'Warning' %}#ff9800
                {% elif states('sensor.aquarium_water_status') == 'Danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_last_test
        name: "Last Tested"

      - type: entity
        entity: sensor.aquarium_ammonia_alert
        name: "Ammonia Status"
        card_mod:
          style: |
            ha-card {
              border-left: 6px solid
                {% set s = states('sensor.aquarium_ammonia_alert') %}
                {% if s == 'Safe' %}#4caf50
                {% elif s == 'WARNING' %}#ff9800
                {% elif s == 'DANGER' %}#f44336
                {% elif s == 'Not Tested' %}#9e9e9e
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_seachem_badge
        name: "Seachem Badge"
        card_mod:
          style: |
            ha-card {
              border-left: 6px solid
                {% set s = states('sensor.aquarium_seachem_badge') | lower %}
                {% if s == 'safe' %}#4caf50
                {% elif s == 'alert' %}#ffeb3b
                {% elif s == 'alarm' %}#ff9800
                {% elif s == 'toxic' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

  # â”€â”€ SEACHEM AMMONIA BADGE DETAIL CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Shows colour, free ammonia level, and urgency guidance
  - type: markdown
    content: >
      ## ğŸŸ¡ Seachem Ammonia Alert Badge

      | | |
      |---|---|
      | **Status** | {{ states('sensor.aquarium_seachem_badge') }} |
      | **Badge Colour** | {{ state_attr('sensor.aquarium_seachem_badge', 'seachem_colour') }} |
      | **Free NHâ‚ƒ** | ~{{ state_attr('sensor.aquarium_seachem_badge', 'free_ammonia_ppm') }} ppm |
      | **Guidance** | {{ state_attr('sensor.aquarium_seachem_badge', 'urgency') }} |

      *Seachem badge reads **free (gaseous) ammonia only** â€” more toxic than total ammonia.
      It detects continuously with ~15 min response time. Safe = yellow, Alert = green, Alarm = blue-green, Toxic = grey.*
    card_mod:
      style: |
        ha-card {
          border-left: 6px solid
            {% set s = states('sensor.aquarium_seachem_badge') | lower %}
            {% if s == 'safe' %}#4caf50
            {% elif s == 'alert' %}#ffeb3b
            {% elif s == 'alarm' %}#ff9800
            {% elif s == 'toxic' %}#f44336
            {% else %}#9e9e9e{% endif %};
        }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 2 â€” UPLOAD & ANALYSE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: vertical-stack
    cards:
      - type: markdown
        content: "## ğŸ“¸ Upload & Analyse Water Test"

      # Test kit selector
      - type: entities
        title: "Test Kit"
        entities:
          - entity: input_select.aquarium_test_kit
            name: "Select your test kit"

      # â”€â”€ BROWSER MOD UPLOAD BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Tapping this opens a popup where you can type/paste
      # the image path after uploading via HA media upload.
      # For phone: use the HA Companion App "Upload media" in the
      # Media browser, upload to /media/aquarium/ folder,
      # then enter the path here.
      - type: button
        name: "ğŸ“· Set Image Path"
        icon: mdi:image-plus
        show_name: true
        show_icon: true
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              title: "ğŸ“· Enter Image Path"
              dismissable: true
              right_button: "âœ… Save & Close"
              right_button_action:
                service: browser_mod.close_popup
              content:
                type: vertical-stack
                cards:
                  - type: markdown
                    content: |
                      **How to upload from your phone:**
                      1. In the HA Companion App, go to **Media** â†’ **Upload**
                      2. Upload your photo to the `aquarium` folder
                      3. The path will be `/media/aquarium/your_filename.jpg`
                      4. Type or paste the full path below and tap Save

                  - type: entities
                    entities:
                      - entity: input_text.aquarium_last_image_path
                        name: "Image Path"

                  - type: markdown
                    content: >
                      **Current path:**
                      `{{ states('input_text.aquarium_last_image_path') }}`

      # â”€â”€ ANALYSE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - type: button
        name: "ğŸ”¬ Analyse Test Now"
        icon: mdi:magnify-scan
        show_name: true
        show_icon: true
        tap_action:
          action: call-service
          service: script.aquarium_analyze_water_test

      # â”€â”€ ANALYSIS RUNNING SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - type: conditional
        conditions:
          - entity: input_boolean.aquarium_analysis_running
            state: "on"
        card:
          type: markdown
          content: |
            â³ **Analysing image with Gemini AI...**

            *This usually takes 5â€“15 seconds.*

      # â”€â”€ CLEAR RESULTS BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - type: button
        name: "ğŸ—‘ Clear Results"
        icon: mdi:refresh
        show_name: true
        show_icon: true
        tap_action:
          action: fire-dom-event
          browser_mod:
            service: browser_mod.popup
            data:
              title: "Clear Results?"
              content: "This will reset all sensor values. Are you sure?"
              dismissable: true
              right_button: "Yes, Clear"
              left_button: "Cancel"
              right_button_action:
                service: script.aquarium_clear_results
              left_button_action:
                service: browser_mod.close_popup

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 3 â€” CURRENT READINGS (with colour-coded alert borders)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: markdown
    content: "## ğŸ’§ Current Water Parameters"

  - type: horizontal-stack
    cards:
      - type: entity
        entity: sensor.aquarium_ph
        name: "pH"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_ph','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_ammonia
        name: "NHâ‚ƒ Ammonia"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_ammonia','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% elif a == 'na' %}#9e9e9e
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_nitrite
        name: "NOâ‚‚ Nitrite"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_nitrite','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

  - type: horizontal-stack
    cards:
      - type: entity
        entity: sensor.aquarium_nitrate
        name: "NOâ‚ƒ Nitrate"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_nitrate','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_gh
        name: "GH Hardness"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_gh','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

      - type: entity
        entity: sensor.aquarium_kh
        name: "KH Alkalinity"
        card_mod:
          style: |
            ha-card {
              border-top: 4px solid
                {% set a = state_attr('sensor.aquarium_kh','alert') %}
                {% if a == 'good' %}#4caf50
                {% elif a == 'warning' %}#ff9800
                {% elif a == 'danger' %}#f44336
                {% else %}#9e9e9e{% endif %};
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 4 â€” AI ADVICE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: markdown
    content: >
      ## ğŸ¤– AI Advice

      {{ states('input_text.aquarium_ai_notes') }}
    card_mod:
      style: |
        ha-card {
          border-left: 4px solid
            {% set s = states('sensor.aquarium_water_status') | lower %}
            {% if s == 'good' %}#4caf50
            {% elif s == 'warning' %}#ff9800
            {% elif s == 'danger' %}#f44336
            {% else %}#9e9e9e{% endif %};
        }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 5 â€” HISTORY GRAPHS
  # Requires mini-graph-card from HACS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: markdown
    content: "## ğŸ“ˆ Water Parameter History"

  # pH & Ammonia side by side
  - type: horizontal-stack
    cards:
      - type: custom:mini-graph-card
        name: "pH History"
        icon: mdi:ph
        entities:
          - entity: sensor.aquarium_ph
            name: pH
            color: "#2196f3"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 6.0
        upper_bound: 8.5
        color_thresholds:
          - value: 6.0
            color: "#f44336"
          - value: 6.8
            color: "#ff9800"
          - value: 7.6
            color: "#4caf50"
          - value: 8.0
            color: "#ff9800"
          - value: 8.5
            color: "#f44336"

      - type: custom:mini-graph-card
        name: "Ammonia History"
        icon: mdi:skull-crossbones-outline
        entities:
          - entity: sensor.aquarium_ammonia
            name: NHâ‚ƒ
            color: "#9c27b0"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 0
        upper_bound: 4
        color_thresholds:
          - value: 0
            color: "#4caf50"
          - value: 0.01
            color: "#ff9800"
          - value: 0.5
            color: "#f44336"

  # Nitrite & Nitrate side by side
  - type: horizontal-stack
    cards:
      - type: custom:mini-graph-card
        name: "Nitrite History"
        icon: mdi:water-alert-outline
        entities:
          - entity: sensor.aquarium_nitrite
            name: NOâ‚‚
            color: "#ff5722"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 0
        upper_bound: 5
        color_thresholds:
          - value: 0
            color: "#4caf50"
          - value: 0.01
            color: "#ff9800"
          - value: 0.5
            color: "#f44336"

      - type: custom:mini-graph-card
        name: "Nitrate History"
        icon: mdi:water-check-outline
        entities:
          - entity: sensor.aquarium_nitrate
            name: NOâ‚ƒ
            color: "#ff9800"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 0
        upper_bound: 160
        color_thresholds:
          - value: 0
            color: "#4caf50"
          - value: 20
            color: "#ff9800"
          - value: 40
            color: "#f44336"

  # GH & KH side by side
  - type: horizontal-stack
    cards:
      - type: custom:mini-graph-card
        name: "GH History"
        icon: mdi:water-opacity
        entities:
          - entity: sensor.aquarium_gh
            name: GH
            color: "#00bcd4"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 0
        upper_bound: 300
        color_thresholds:
          - value: 0
            color: "#f44336"
          - value: 70
            color: "#4caf50"
          - value: 150
            color: "#ff9800"
          - value: 300
            color: "#f44336"

      - type: custom:mini-graph-card
        name: "KH History"
        icon: mdi:water-minus-outline
        entities:
          - entity: sensor.aquarium_kh
            name: KH
            color: "#009688"
        hours_to_show: 336
        points_per_hour: 0.05
        line_width: 2
        show:
          labels: true
          points: true
          legend: false
          state: true
        lower_bound: 0
        upper_bound: 240
        color_thresholds:
          - value: 0
            color: "#f44336"
          - value: 70
            color: "#4caf50"
          - value: 140
            color: "#ff9800"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROW 6 â€” REFERENCE TABLE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  - type: markdown
    content: |
      ## ğŸ“‹ Safe Ranges â€” Freshwater Tropical Fish

      | Parameter | ğŸŸ¢ Safe | ğŸŸ  Warning | ğŸ”´ Danger |
      |-----------|---------|-----------|---------|
      | pH | 6.8 â€“ 7.6 | 6.0â€“6.8 or 7.6â€“8.0 | < 6.0 or > 8.0 |
      | Ammonia NHâ‚ƒ | 0 ppm | 0.01â€“0.25 ppm | â‰¥ 0.5 ppm |
      | Nitrite NOâ‚‚ | 0 ppm | 0.01â€“0.25 ppm | â‰¥ 0.5 ppm |
      | Nitrate NOâ‚ƒ | < 20 ppm | 20â€“40 ppm | â‰¥ 40 ppm |
      | GH | 70â€“150 ppm | 30â€“70 or 150â€“300 ppm | < 30 or > 300 ppm |
      | KH | 70â€“140 ppm | 40â€“70 or > 140 ppm | < 40 ppm |

      ## ğŸŸ¡ Seachem Ammonia Alert Badge Colour Guide

      | Colour | Status | Free NHâ‚ƒ | Tolerance |
      |--------|--------|----------|-----------|
      | ğŸŸ¡ Yellow | Safe | 0 ppm | No action needed |
      | ğŸŸ¢ Green | Alert | ~0.05 ppm | Monitor â€” tolerated 3â€“5 days |
      | ğŸ”µ Blue-green | Alarm | ~0.2 ppm | Act within 1â€“3 days |
      | â¬œ Grey / Blue-grey | Toxic | ~0.5 ppm | Immediate action required |

      *âš ï¸ API 5-in-1 Strip does not test Ammonia â€” use Seachem badge or liquid kit*
      *Seachem badge detects free (gaseous) NHâ‚ƒ only â€” the form most toxic to fish*
